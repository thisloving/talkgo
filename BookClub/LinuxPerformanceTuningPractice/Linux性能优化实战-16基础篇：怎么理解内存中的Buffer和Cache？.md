



## free 数据的来源

+ Buffers 是内核缓冲区用到的内存，对应的是  /proc/meminfo 中的 Buffers 值。

  ```
  ntu:/home/leving# cat /proc/meminfo  | grep Buffers
  Buffers:           74044 kB
  root@ubuntu:/home/leving# 
  ```

+ Cache 是内核页缓存和 Slab 用到的内存，对应的是  /proc/meminfo 中的 Cached 与 SReclaimable 之和。

```
ntu:/home/leving# cat /proc/meminfo  | grep -w "Cached"
Cached:          1706036 kB
root@ubuntu:/home/leving# cat /proc/meminfo  | grep "SReclaimable"
SReclaimable:     238476 kB
```

## proc 文件系统

+ Buffers 是对原始磁盘块的临时存储，也就是用来缓存磁盘的数据，通常不会特别大（20MB 左右）。
+ Cached 是从磁盘读取文件的页缓存，也就是用来缓存从文件读取的数据。这样，下次访问这些文件数据时，就可以直接从内存中快速获取，而不需要再次访问缓慢的磁盘。
+ SReclaimable 是 Slab 的一部分。Slab 包括两部分，其中的可回收部分，用 SReclaimable 记录；而不可回收部分，用 SUnreclaim 记录。

## 案例

```
//清理文件页、目录项、Inodes等各种缓存
[root@izbp1goz1ulmtus2vec80fz ~]# echo 3 > /proc/sys/vm/drop_caches
[root@izbp1goz1ulmtus2vec80fz ~]# 
```

这里的 /proc/sys/vm/drop_caches ，就是通过 proc 文件系统修改内核行为的一个示例，写入 3 表示清理文件页、目录项、Inodes 等各种缓存

### 场景 1：磁盘和文件写案例

```
[root@izbp1goz1ulmtus2vec80fz ~]# vmstat 1
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 3  0      0 1330832   5836 332276    0    0     1     4    1    0  0  0 99  0  0
 1  0      0 1330832   5836 332276    0    0     0     0  566  972  0  1 99  0  0
 0  0      0 1330864   5836 332276    0    0     0     0  531  937  1  0 99  0  0
 3  0      0 1330864   5836 332276    0    0     0     0  523  950  0  1 99  0  0
 0  0      0 1330864   5836 332276    0    0     0     0  535  950  1  0 99  0  0
 0  0      0 1330864   5840 332276    0    0     0     4  554  950  1  0 99  0  0
 0  0      0 1330864   5840 332276    0    0     0     0  509  913  0  1 99  0  0
```

+ buff 和 cache 就是我们前面看到的 Buffers 和 Cache，单位是 KB。
+ bi 和 bo 则分别表示块设备读取和写入的大小，单位为块 / 秒。

通过读取随机设备，生成一个 500MB 大小的文件：

```
[root@izbp1goz1ulmtus2vec80fz ~]#  dd if=/dev/urandom of=/tmp/file bs=1M count=500
500+0 records in
500+0 records out
524288000 bytes (524 MB) copied, 4.0659 s, 129 MB/s
```

```
[root@izbp1goz1ulmtus2vec80fz ~]# vmstat 1

 0  0      0 1330752   5864 332344    0    0     0     0  533  957  1  0 99  0  0
 0  0      0 1328256   6400 333628    0    0  1800     0  774 1322  1  3 89  7  0
 0  0      0 1328256   6400 333628    0    0     0     0  618 1021  1  1 98  0  0
 1  0      0 1201108   6404 459516    0    0    96     0 1234  806  0 88 12  0  0
 1  0      0 1076044   6408 584584    0    0     4 114708 1235  794  1 86  0 13  0
 1  0      0 937556   6412 723240    0    0     4 172032 1324  756  0 98  0  2  0
 3  2      0 831272   6424 829368    0    0     4 123944 1144  815  0 77  0 23  0
 0  1      0 803824   6432 857680    0    0     4 101396  743  984  0 20  0 80  0

procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 3  0      0 804264   6600 857616    0    0     1     4    1    0  0  0 99  0  0
 0  0      0 804264   6600 857616    0    0     0     0  566  970  1  0 99  0  0
 0  0      0 804264   6600 857616    0    0     0     0  540  949  1  0 99  0  0
 0  0      0 804264   6600 857616    0    0     0     0  572  968  0  1 99  0  0
 0  0      0 804264   6600 857616    0    0     0     0  573 1014  1  0 99  0  0
 0  0      0 804264   6600 857616    0    0     0     0  545  960  0  1 99  0  0
 0  0      0 804264   6600 857616    0    0     0     0  518  939  1  1 98  0  0
```

通过观察 vmstat 的输出，我们发现，在 dd 命令运行时， Cache 在不停地增长，而 Buffer 基本保持不变。

（接下来硬盘原因，实验未做）

### 场景 2：磁盘和文件读案例

```
[root@izbp1goz1ulmtus2vec80fz ~]#  echo 3 > /proc/sys/vm/drop_caches
[root@izbp1goz1ulmtus2vec80fz ~]#  dd if=/tmp/file of=/dev/null
1024000+0 records in
1024000+0 records out
524288000 bytes (524 MB) copied, 3.49633 s, 150 MB/s
```

```
敲完以上指令后观察：vmstat 1
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 1  0      0 1547928    524 119544    0    0     0     0  544  945  1  0 99  0  0
 0  0      0 1547928    524 119544    0    0     0     0  537  967  0  1 99  0  0
 0  0      0 1547928    524 119544    0    0     0     0  573  961  1  1 98  0  0
 0  0      0 1547928    524 119544    0    0     0     0  566  961  1  0 99  0  0
 0  0      0 1547960    524 119544    0    0     0     0  523  943  0  1 99  0  0
 0  0      0 1547704    524 119544    0    0     0     0  552  961  0  1 99  0  0
 0  1      0 1414228   1768 251744    0    0 133436     0 1216 1378  3 14 12 71  0
 0  1      0 1270848   1768 395064    0    0 143360     0 1032 1303  2 16  0 82  0
 0  1      0 1127248   2044 538468    0    0 143640     0 1075 1332  3 14  0 83  0
 0  0      0 1033000   2072 632860    0    0 94416     0  925 1242  2 11 34 53  0
 0  0      0 1033000   2076 632864    0    0    20     0  588 1019  1  1 97  1  0
 0  0      0 1033000   2076 632864    0    0     0     0  600 1017  0  0 100  0  0
 0  0      0 1033032   2076 632864    0    0     0     0  604 1029  1  1 98  0  0
 0  0      0 1033032   2076 632864    0    0     0     0  567 1011  0  0 100  0  0
 0  0      0 1033032   2084 632860    0    0     0    12  601 1034  1  1 98  0  0
 0  0      0 1033032   2084 632864    0    0     0     0  596 1021  0  1 99  0  0
 0  0      0 1033032   2084 632864    0    0     0     0  561 1008  1  0 99  0  0
 0  0      0 1033032   2084 632864    0    0     0     0  588 1012  0  0 100  0  0
 0  0      0 1033032   2084 632864    0    0     0     0  596 1011  0  1 99  0  0
```

